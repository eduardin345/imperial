// crud_script.js
document.addEventListener('DOMContentLoaded', () => {
    const apiUrlBase = 'http://localhost:3002/api'; // URL base da sua API Node.js

    const formVeiculo = document.getElementById('form-veiculo');
    const formTitle = document.getElementById('form-title');
    const veiculoIdInput = document.getElementById('veiculo-id');
    const modeloInput = document.getElementById('modelo');
    const marcaSelect = document.getElementById('marca');
    const categoriaSelect = document.getElementById('categoria');
    const anoInput = document.getElementById('ano');
    const corInput = document.getElementById('cor');
    const precoInput = document.getElementById('preco');
    const descricaoTextarea = document.getElementById('descricao');
    const disponivelCheckbox = document.getElementById('disponivel');
    const submitButton = document.getElementById('submit-button');
    const clearButton = document.getElementById('clear-button');

    const corpoTabelaVeiculos = document.getElementById('corpo-tabela-veiculos');
    const searchVeiculoInput = document.getElementById('search-veiculo-input');

    let editando = false;

    // --- FUN√á√ïES DE CARREGAMENTO INICIAL (MARCAS, CATEGORIAS, VE√çCULOS) ---

    async function carregarMarcas() {
        try {
            const response = await fetch(`${apiUrlBase}/marcas`); // Substitua pela sua rota real de marcas
            if (!response.ok) throw new Error(`Erro ao buscar marcas: ${response.statusText}`);
            const marcas = await response.json();

            marcaSelect.innerHTML = '<option value="">Selecione uma marca...</option>'; // Limpa e adiciona default
            marcas.forEach(marca => {
                const option = document.createElement('option');
                option.value = marca.id_marca; // Supondo que sua API retorna id_marca
                option.textContent = marca.nome_marca;
                marcaSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Falha ao carregar marcas:', error);
            marcaSelect.innerHTML = '<option value="">Erro ao carregar marcas</option>';
        }
    }

    async function carregarCategorias() {
        try {
            const response = await fetch(`${apiUrlBase}/categorias`);
            if (!response.ok) throw new Error(`Erro ao buscar categorias: ${response.statusText}`);
            const categorias = await response.json();

            categoriaSelect.innerHTML = '<option value="">Selecione uma categoria...</option>';
            categorias.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria.id_categoria; // Supondo id_categoria
                option.textContent = categoria.nome_categoria;
                categoriaSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Falha ao carregar categorias:', error);
            categoriaSelect.innerHTML = '<option value="">Erro ao carregar categorias</option>';
        }
    }

    async function carregarVeiculos(termoBusca = '') {
        try {
            // Se houver termo de busca, precisaremos de um endpoint de API que o suporte.
            // Por enquanto, vamos carregar todos ou filtrar no frontend (n√£o ideal para muitos dados).
            // A API de /veiculos/categoria/:slugCategoria j√° existe. Poder√≠amos ter /veiculos para todos.
            // ASSUMINDO que voc√™ ter√° um endpoint como /api/veiculos que retorna todos os ve√≠culos
            // E que ele pode aceitar um query param para busca, ex: /api/veiculos?modelo=Huracan

            let url = `${apiUrlBase}/veiculos`; // Endpoint hipot√©tico para listar todos
            if (termoBusca) {
                 // A forma de passar o termo de busca depende da sua API:
                // url += `?search=${encodeURIComponent(termoBusca)}`; // Exemplo de query param
                // OU, se voc√™ filtrar apenas por categoria aqui:
                // url = `${apiUrlBase}/veiculos/categoria/${encodeURIComponent(termoBusca)}`;
                console.warn("A busca no frontend ainda n√£o est√° implementada para buscar do backend. Listando todos.");
            }

            // Para este exemplo, vamos pegar os ve√≠culos de uma categoria padr√£o ou todos
            // e filtrar no frontend (N√ÉO RECOMENDADO PARA MUITOS DADOS)
            // A melhor abordagem seria o backend fazer a filtragem
            // Vamos usar o endpoint de categoria que j√° existe como exemplo:
            // Troque 'esportivos' pela categoria desejada ou um endpoint que liste todos
            const response = await fetch(`${apiUrlBase}/veiculos`); // Carrega todos os ve√≠culos // PEGANDO S√ì ESPORTIVOS POR ENQUANTO
            if (!response.ok && response.status !== 404) throw new Error(`Erro HTTP: ${response.status}`);
            
            const veiculos = response.status === 404 ? [] : await response.json();

            corpoTabelaVeiculos.innerHTML = ''; // Limpa a tabela

            if (veiculos.length === 0) {
                const tr = corpoTabelaVeiculos.insertRow();
                const td = tr.insertCell();
                td.colSpan = 8; // N√∫mero de colunas na sua tabela
                td.textContent = 'Nenhum ve√≠culo encontrado.';
                td.style.textAlign = 'center';
                return;
            }
            
            // Filtro frontend simples (apenas para demonstra√ß√£o se a API n√£o filtrar)
            const veiculosFiltrados = termoBusca ? veiculos.filter(v => v.modelo.toLowerCase().includes(termoBusca.toLowerCase())) : veiculos;


            veiculosFiltrados.forEach(veiculo => {
                const tr = corpoTabelaVeiculos.insertRow();
                tr.innerHTML = `
                    <td>${veiculo.id_veiculo}</td>
                    <td>${veiculo.modelo}</td>
                    <td>${veiculo.nome_marca}</td> {/* Supondo que a API retorna nome_marca */}
                    <td>${veiculo.nome_categoria}</td> {/* Supondo que a API retorna nome_categoria */}
                    <td>${veiculo.ano || 'N/A'}</td>
                    <td>R$ ${parseFloat(veiculo.preco || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td>${veiculo.disponivel !== undefined ? (veiculo.disponivel ? 'Sim' : 'N√£o') : 'N/A'}</td>
                    <td>
                        <button class="edit-btn" data-id="${veiculo.id_veiculo}">‚úèÔ∏è Editar</button>
                        <button class="delete-btn" data-id="${veiculo.id_veiculo}">üóëÔ∏è Deletar</button>
                    </td>
                `;
                // Adicionar listeners aos bot√µes de editar/deletar
                tr.querySelector('.edit-btn').addEventListener('click', () => popularFormularioParaEdicao(veiculo));
                tr.querySelector('.delete-btn').addEventListener('click', () => deletarVeiculo(veiculo.id_veiculo, veiculo.modelo));
            });
        } catch (error) {
            console.error('Falha ao carregar ve√≠culos:', error);
            corpoTabelaVeiculos.innerHTML = `<tr><td colspan="8" style="text-align:center; color:red;">Erro ao carregar ve√≠culos.</td></tr>`;
        }
    }


    // --- L√ìGICA DO FORMUL√ÅRIO (CRIAR/ATUALIZAR) ---
    formVeiculo.addEventListener('submit', async (event) => {
        event.preventDefault();

        const dadosVeiculo = {
            modelo: modeloInput.value,
            id_marca_fk: parseInt(marcaSelect.value),
            id_categoria_fk: parseInt(categoriaSelect.value),
            ano: anoInput.value ? parseInt(anoInput.value) : null,
            cor: corInput.value || null,
            preco: precoInput.value ? parseFloat(precoInput.value) : null,
            descricao: descricaoTextarea.value || null,
            disponivel: disponivelCheckbox.checked
        };

        const id = veiculoIdInput.value;
        let url = `${apiUrlBase}/veiculos`; // Endpoint para criar
        let method = 'POST';

        if (editando && id) {
            url = `${apiUrlBase}/veiculos/${id}`; // Endpoint para atualizar
            method = 'PUT'; // Ou 'PATCH' dependendo da sua API
            // Adicione o ID ao corpo se sua API de PUT/PATCH precisar dele no corpo tamb√©m
            // dadosVeiculo.id_veiculo = parseInt(id);
        }

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dadosVeiculo),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Erro ao ${editando ? 'atualizar' : 'salvar'} ve√≠culo`);
            }

            const resultado = await response.json();
            alert(`Ve√≠culo ${editando ? 'atualizado' : 'salvo'} com sucesso! ID: ${resultado.id || id}`); // Sua API deve retornar o ID
            resetarFormulario();
            carregarVeiculos(); // Recarrega a lista

        } catch (error) {
            console.error(`Erro ao ${editando ? 'atualizar' : 'salvar'} ve√≠culo:`, error);
            alert(`Falha: ${error.message}`);
        }
    });

    function resetarFormulario() {
        formVeiculo.reset();
        veiculoIdInput.value = '';
        formTitle.textContent = 'Adicionar Novo Ve√≠culo';
        submitButton.textContent = 'Salvar Ve√≠culo';
        editando = false;
        disponivelCheckbox.checked = true; // Valor padr√£o
        modeloInput.focus();
    }

    clearButton.addEventListener('click', resetarFormulario);

    function popularFormularioParaEdicao(veiculo) {
        formTitle.textContent = `Editando Ve√≠culo: ${veiculo.modelo}`;
        submitButton.textContent = 'Atualizar Ve√≠culo';
        editando = true;

        veiculoIdInput.value = veiculo.id_veiculo;
        modeloInput.value = veiculo.modelo;
        marcaSelect.value = veiculo.id_marca_fk || (veiculo.marca ? veiculo.marca.id_marca : ''); // Adaptar conforme sua API retorna
        categoriaSelect.value = veiculo.id_categoria_fk || (veiculo.categoria ? veiculo.categoria.id_categoria : ''); // Adaptar
        anoInput.value = veiculo.ano || '';
        corInput.value = veiculo.cor || '';
        precoInput.value = veiculo.preco || '';
        descricaoTextarea.value = veiculo.descricao || '';
        disponivelCheckbox.checked = veiculo.disponivel !== undefined ? veiculo.disponivel : true;

        window.scrollTo({ top: formVeiculoSection.offsetTop - 20, behavior: 'smooth' });
        modeloInput.focus();
    }


    // --- L√ìGICA PARA DELETAR ---
    async function deletarVeiculo(id, modelo) {
        if (!confirm(`Tem certeza que deseja deletar o ve√≠culo "${modelo}" (ID: ${id})?`)) {
            return;
        }
        try {
            const response = await fetch(`${apiUrlBase}/veiculos/${id}`, {
                method: 'DELETE',
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Erro ao deletar ve√≠culo');
            }
            alert(`Ve√≠culo "${modelo}" deletado com sucesso!`);
            carregarVeiculos(); // Recarrega a lista
        } catch (error) {
            console.error('Erro ao deletar ve√≠culo:', error);
            alert(`Falha ao deletar: ${error.message}`);
        }
    }

    // --- BUSCA NA TABELA (FILTRO FRONTEND SIMPLES) ---
    searchVeiculoInput.addEventListener('input', (e) => {
        const termo = e.target.value.toLowerCase();
        // A fun√ß√£o carregarVeiculos precisaria ser adaptada para realmente usar o termo no backend,
        // ou voc√™ filtra no frontend, o que N√ÉO √© ideal para muitos dados.
        // Por ora, vamos refiltrar os dados j√° carregados (se for o caso) ou recarregar tudo com o termo.
        carregarVeiculos(termo); // Se sua fun√ß√£o carregarVeiculos j√° lida com filtro frontend.
    });


    // --- INICIALIZA√á√ÉO DA P√ÅGINA ---
    function initCrudPage() {
        carregarMarcas();
        carregarCategorias();
        carregarVeiculos(); // Carrega todos os ve√≠culos inicialmente (ou da categoria padr√£o)
        resetarFormulario();
    }

    initCrudPage();
});

// server.js

import express from 'express';
import cors from 'cors';
import sqlite3 from 'sqlite3';
import dotenv from 'dotenv';
// import axios from 'axios'; // Se for usar a API de previs√£o do tempo

dotenv.config();

// ---- CONFIGURA√á√ÉO DO BANCO DE DADOS SQLITE ----
const dbFile = './imperial_data.db';
const db = new sqlite3.Database(dbFile, sqlite3.OPEN_READWRITE, (err) => {
    if (err) {
        console.error(`[SERVIDOR] ERRO ao conectar ao banco de dados SQLite '${dbFile}':`, err.message);
    } else {
        console.log(`[SERVIDOR] Conectado com sucesso ao banco de dados SQLite: ${dbFile}`);
        db.run("PRAGMA foreign_keys = ON;", (pragmaErr) => {
            if (pragmaErr) console.error("[SERVIDOR] ERRO ao ativar PRAGMA foreign_keys:", pragmaErr.message);
            else console.log("[SERVIDOR] PRAGMA foreign_keys ativada.");
        });
    }
});
// ----------------------------------------------

const app = express();
const PORTA_SERVIDOR = process.env.PORT || 3002;

app.use(cors());
app.use(express.json());

// --- ROTAS DA API PARA O SITE IMPERIAL ---

app.get('/api', (req, res) => {
    res.json({ message: 'Bem-vindo √† API do Site IMPERIAL!' });
});

// ==== NOVA ROTA PARA LISTAR MARCAS ====
app.get('/api/marcas', (req, res) => {
    const sql = "SELECT id_marca, nome_marca, logo_url FROM marcas ORDER BY nome_marca ASC";
    db.all(sql, [], (err, rows) => {
        if (err) {
            console.error("[SERVIDOR] Erro ao buscar marcas:", err.message);
            return res.status(500).json({ error: 'Erro ao buscar marcas no servidor.' });
        }
        res.json(rows);
    });
});

// ==== ROTA PARA LISTAR CATEGORIAS (J√Å EXISTENTE, MAS CONFERIR) ====
app.get('/api/categorias', (req, res) => {
    // Modifiquei para incluir a descri√ß√£o, se voc√™ adicionou no DB
    const sql = "SELECT id_categoria, nome_categoria, slug_categoria, descricao_categoria FROM categorias ORDER BY nome_categoria ASC";
    db.all(sql, [], (err, rows) => {
        if (err) {
            console.error("[SERVIDOR] Erro ao buscar categorias:", err.message);
            return res.status(500).json({ error: 'Erro ao buscar categorias no servidor.' });
        }
        res.json(rows);
    });
});


// Rota para listar ve√≠culos de uma categoria espec√≠fica (como antes)
app.get('/api/veiculos/categoria/:slugCategoria', (req, res) => {
    const { slugCategoria } = req.params;
    const sql = `
        SELECT v.id_veiculo, v.modelo, v.ano, v.preco, v.cor, v.disponivel, v.descricao, 
               m.nome_marca, c.nome_categoria
        FROM veiculos v
        JOIN marcas m ON v.id_marca_fk = m.id_marca
        JOIN categorias c ON v.id_categoria_fk = c.id_categoria
        WHERE c.slug_categoria = ?
        ORDER BY v.modelo ASC
    `;
    db.all(sql, [slugCategoria], (err, rows) => {
        if (err) {
            console.error(`[SERVIDOR] Erro ao buscar ve√≠culos para '${slugCategoria}':`, err.message);
            return res.status(500).json({ error: 'Erro ao buscar ve√≠culos da categoria.' });
        }
        // Aqui voc√™ pode adicionar a l√≥gica para buscar as imagens de cada ve√≠culo se quiser
        // ou deixar para o endpoint /api/veiculos/:idVeiculo fazer isso.
        res.json(rows);
    });
});

// Rota para buscar detalhes de um ve√≠culo espec√≠fico pelo ID (como antes)
app.get('/api/veiculos/:idVeiculo', (req, res) => {
    const { idVeiculo } = req.params;
    const sqlVeiculo = `
        SELECT v.id_veiculo, v.modelo, v.ano, v.cor, v.preco, v.disponivel, v.descricao,
               m.nome_marca, c.nome_categoria, m.id_marca AS id_marca_fk, c.id_categoria AS id_categoria_fk 
               /* Adicionando IDs de FK para preencher formul√°rio de edi√ß√£o */
        FROM veiculos v
        JOIN marcas m ON v.id_marca_fk = m.id_marca
        JOIN categorias c ON v.id_categoria_fk = c.id_categoria
        WHERE v.id_veiculo = ?
    `;
    const sqlImagens = `SELECT id_imagem, url_imagem, imagem_principal, ordem FROM imagens_veiculos WHERE id_veiculo_fk = ? ORDER BY ordem ASC, imagem_principal DESC`;

    db.get(sqlVeiculo, [idVeiculo], (err, veiculo) => {
        if (err) {
            console.error(`[SERVIDOR] Erro ao buscar ve√≠culo ID '${idVeiculo}':`, err.message);
            return res.status(500).json({ error: 'Erro ao buscar detalhes do ve√≠culo.' });
        }
        if (!veiculo) {
            return res.status(404).json({ message: `Ve√≠culo com ID '${idVeiculo}' n√£o encontrado.` });
        }

        db.all(sqlImagens, [idVeiculo], (errImgs, imagens) => {
            if (errImgs) {
                console.error(`[SERVIDOR] Erro ao buscar imagens para ve√≠culo ID '${idVeiculo}':`, errImgs.message);
                veiculo.imagens = [];
            } else {
                veiculo.imagens = imagens;
            }
            res.json(veiculo);
        });
    });
});


// ==== NOVAS ROTAS CRUD PARA VE√çCULOS (Exemplos) ====

// CRIAR um novo ve√≠culo (POST)
app.post('/api/veiculos', (req, res) => {
    const { modelo, id_marca_fk, id_categoria_fk, ano, cor, preco, descricao, disponivel } = req.body;

    // Valida√ß√£o b√°sica dos dados recebidos
    if (!modelo || !id_marca_fk || !id_categoria_fk) {
        return res.status(400).json({ error: 'Modelo, ID da Marca e ID da Categoria s√£o obrigat√≥rios.' });
    }

    const sql = `INSERT INTO veiculos (modelo, id_marca_fk, id_categoria_fk, ano, cor, preco, descricao, disponivel)
                 VALUES (?, ?, ?, ?, ?, ?, ?, ?)`;
    const params = [modelo, id_marca_fk, id_categoria_fk, ano, cor, preco, descricao, (disponivel !== undefined ? disponivel : true)];

    db.run(sql, params, function(err) { // Usar function() para ter acesso a this.lastID
        if (err) {
            console.error("[SERVIDOR] Erro ao inserir ve√≠culo:", err.message);
            return res.status(500).json({ error: 'Erro ao inserir ve√≠culo no banco de dados.' });
        }
        res.status(201).json({ id_veiculo: this.lastID, message: 'Ve√≠culo criado com sucesso!' });
    });
});

// ATUALIZAR um ve√≠culo existente (PUT)
app.put('/api/veiculos/:idVeiculo', (req, res) => {
    const { idVeiculo } = req.params;
    const { modelo, id_marca_fk, id_categoria_fk, ano, cor, preco, descricao, disponivel } = req.body;

    if (!modelo || !id_marca_fk || !id_categoria_fk) {
        return res.status(400).json({ error: 'Modelo, ID da Marca e ID da Categoria s√£o obrigat√≥rios para atualiza√ß√£o.' });
    }

    const sql = `UPDATE veiculos 
                 SET modelo = ?, id_marca_fk = ?, id_categoria_fk = ?, ano = ?, cor = ?, 
                     preco = ?, descricao = ?, disponivel = ?
                 WHERE id_veiculo = ?`;
    const params = [modelo, id_marca_fk, id_categoria_fk, ano, cor, preco, descricao, (disponivel !== undefined ? disponivel : true), idVeiculo];

    db.run(sql, params, function(err) {
        if (err) {
            console.error(`[SERVIDOR] Erro ao atualizar ve√≠culo ID '${idVeiculo}':`, err.message);
            return res.status(500).json({ error: 'Erro ao atualizar ve√≠culo.' });
        }
        if (this.changes === 0) {
            return res.status(404).json({ message: `Ve√≠culo com ID '${idVeiculo}' n√£o encontrado para atualiza√ß√£o.` });
        }
        res.json({ message: `Ve√≠culo ID '${idVeiculo}' atualizado com sucesso!` });
    });
});

// DELETAR um ve√≠culo (DELETE)
app.delete('/api/veiculos/:idVeiculo', (req, res) => {
    const { idVeiculo } = req.params;
    // Primeiro deletar imagens associadas (devido ao ON DELETE CASCADE na tabela imagens_veiculos, isso pode n√£o ser estritamente necess√°rio se a constraint funcionar, mas √© bom saber)
    // db.run(`DELETE FROM imagens_veiculos WHERE id_veiculo_fk = ?`, [idVeiculo], (errImg) => {
    //     if (errImg) { ... } // Tratar erro de imagens
    // });
    const sql = `DELETE FROM veiculos WHERE id_veiculo = ?`;
    db.run(sql, [idVeiculo], function(err) {
        if (err) {
            console.error(`[SERVIDOR] Erro ao deletar ve√≠culo ID '${idVeiculo}':`, err.message);
            // Se o erro for FOREIGN KEY constraint, √© porque ON DELETE RESTRICT em outras tabelas o impediu.
            return res.status(500).json({ error: 'Erro ao deletar ve√≠culo. Verifique depend√™ncias.' });
        }
        if (this.changes === 0) {
            return res.status(404).json({ message: `Ve√≠culo com ID '${idVeiculo}' n√£o encontrado para dele√ß√£o.` });
        }
        res.json({ message: `Ve√≠culo ID '${idVeiculo}' deletado com sucesso!` });
    });
});


// Rota de Previs√£o do Tempo (OPCIONAL, como antes)
const apiKeyOpenWeather = process.env.OPENWEATHER_API_KEY;
if (apiKeyOpenWeather) {
    // ... (c√≥digo da previs√£o do tempo, n√£o mudou)
} else {
    console.warn("[SERVIDOR] API de previs√£o do tempo desativada.");
}


// Middlewares de 404 e Erro Gen√©rico (como antes)
app.use((req, res, next) => { res.status(404).json({ error: `Endpoint n√£o encontrado: ${req.originalUrl}` }); });
app.use((err, req, res, next) => { console.error('[SERVIDOR] Erro n√£o tratado:', err.stack || err); res.status(500).json({ error: 'Erro inesperado no servidor.' }); });

// Inicializa√ß√£o do Servidor (como antes)
app.listen(PORTA_SERVIDOR, () => { /* ... logs ... */ });
process.on('SIGINT', () => { /* ... graceful shutdown ... */ });// crud_script.js (trecho relevante)

// ... (outros seletores e c√≥digo) ...
const apiUrlBase = 'http://localhost:3002/api'; // CONFIRME ESTA URL E PORTA
const marcaSelect = document.getElementById('marca');
const categoriaSelect = document.getElementById('categoria');

// --- FUN√á√ïES DE CARREGAMENTO INICIAL (MARCAS, CATEGORIAS, VE√çCULOS) ---

async function carregarMarcas() {
    try {
        console.log('[CRUD] Tentando carregar marcas de:', `${apiUrlBase}/marcas`); // DEBUG
        const response = await fetch(`${apiUrlBase}/marcas`);
        console.log('[CRUD] Resposta de marcas:', response); // DEBUG

        if (!response.ok) {
            // Tenta ler o corpo do erro se n√£o for ok, para mais detalhes
            let errorBody = 'Detalhes do erro n√£o dispon√≠veis.';
            try {
                errorBody = await response.text(); // Ou response.json() se souber que √© JSON
            } catch (e) { /* ignora se n√£o puder ler o corpo */ }
            throw new Error(`Erro HTTP ${response.status} ao buscar marcas: ${response.statusText}. Corpo: ${errorBody}`);
        }
        const marcas = await response.json();
        console.log('[CRUD] Marcas recebidas:', marcas); // DEBUG

        marcaSelect.innerHTML = '<option value="">Selecione uma marca...</option>';
        if (marcas && marcas.length > 0) { // Adiciona verifica√ß√£o se marcas √© um array e tem itens
            marcas.forEach(marca => {
                const option = document.createElement('option');
                option.value = marca.id_marca;
                option.textContent = marca.nome_marca;
                marcaSelect.appendChild(option);
            });
        } else {
            console.log('[CRUD] Nenhuma marca retornada pela API ou array vazio.');
        }
    } catch (error) {
        console.error('[CRUD] Falha ao carregar marcas:', error);
        marcaSelect.innerHTML = '<option value="">Erro ao carregar marcas</option>';
    }
}

async function carregarCategorias() {
    try {
        console.log('[CRUD] Tentando carregar categorias de:', `${apiUrlBase}/categorias`); // DEBUG
        const response = await fetch(`${apiUrlBase}/categorias`);
        console.log('[CRUD] Resposta de categorias:', response); // DEBUG

        if (!response.ok) {
            let errorBody = 'Detalhes do erro n√£o dispon√≠veis.';
            try { errorBody = await response.text(); } catch (e) {}
            throw new Error(`Erro HTTP ${response.status} ao buscar categorias: ${response.statusText}. Corpo: ${errorBody}`);
        }
        const categorias = await response.json();
        console.log('[CRUD] Categorias recebidas:', categorias); // DEBUG

        categoriaSelect.innerHTML = '<option value="">Selecione uma categoria...</option>';
        if (categorias && categorias.length > 0) { // Adiciona verifica√ß√£o
            categorias.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria.id_categoria;
                option.textContent = categoria.nome_categoria;
                categoriaSelect.appendChild(option);
            });
        } else {
             console.log('[CRUD] Nenhuma categoria retornada pela API ou array vazio.');
        }
    } catch (error) {
        console.error('[CRUD] Falha ao carregar categorias:', error);
        categoriaSelect.innerHTML = '<option value="">Erro ao carregar categorias</option>';
    }
}

// ... (resto do seu crud_script.js) ...

// --- INICIALIZA√á√ÉO DA P√ÅGINA ---
function initCrudPage() {
    console.log("[CRUD] Inicializando p√°gina CRUD..."); // DEBUG
    carregarMarcas();
    carregarCategorias();
    // carregarVeiculos(); // Voc√™ pode comentar isso temporariamente para focar nos selects
    resetarFormulario(); // Se esta fun√ß√£o existir
}

initCrudPage();

